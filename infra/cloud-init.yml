#cloud-config
package_update: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg-agent
  - software-properties-common
  - unattended-upgrades
  - git

# Enable ipv4 forwarding, required on CIS hardened machines
write_files:
  - path: /etc/sysctl.d/enabled_ipv4_forwarding.conf
    content: |
      net.ipv4.conf.all.forwarding=1

# create the docker group
groups:
  - docker

users:
  - default
  - name: deploy
    shell: /bin/bash
    lock_passwd: true
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: adm, sudo, docker
    ssh_authorized_keys:
      - ${0}

# Add default auto created user to docker group
system_info:
  default_user:
    groups: adm, sudo, docker

runcmd:
  - |
    curl -fsSL https://get.docker.com | sh
    docker pull -q nginxproxy/nginx-proxy:1.5
    docker pull -q nginxproxy/acme-companion
    docker pull -q nginxproxy/docker-gen
    docker run --detach \
      --name nginx-proxy \
      --publish 80:80 \
      --publish 443:443 \
      --volume certs:/etc/nginx/certs \
      --volume vhost:/etc/nginx/vhost.d \
      --volume html:/usr/share/nginx/html \
      --volume /var/run/docker.sock:/tmp/docker.sock:ro \
      nginxproxy/nginx-proxy:1.5
    docker run --detach \
      --name nginx-proxy-acme \
      --volumes-from nginx-proxy \
      --volume /var/run/docker.sock:/var/run/docker.sock:ro \
      --volume acme:/etc/acme.sh \
      --env "DEFAULT_EMAIL=${1}" \
      nginxproxy/acme-companion
